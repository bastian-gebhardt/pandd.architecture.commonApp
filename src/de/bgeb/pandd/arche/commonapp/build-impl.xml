<!DOCTYPE project>
<project name="pandd_build_impl" basedir="." xmlns:artifact="antlib:org.apache.maven.artifact.ant">
    <description>
    	Implementation from Build file for Pandd Framework Developing
    	(there are nothing to configure in this file)
    </description>

	
	
    <!-- Betriebssystemunabhaengige Loesung finden -->
    <exec executable="sed" inputstring="${project_groupId}" outputproperty="project_groupId_as_path">
      <arg value="s/\./\//g"/>
    </exec>
    	
	<target name="setup" depends="_copy_skeleton, _create_packages, _copy_pom, _copy_build-interface, _copy_pandd, update-dependencies">
		<!-- move pandd into lib-folder -->
		<!-- copy skeleton -->
		<!-- create src/groupId/artifactId -->
		<!-- create test/groupId/artifactId -->
		<!-- copy pom -->
		<!-- copy framework build-inteface -->
		<!-- copy pandd file -->
	</target>
	
	<target name="_copy_skeleton">
		<defaultexcludes remove="**/.gitignore"/>
		<copy todir=".">
		    <fileset dir="lib/${arche_groupIdAsPath}/${arche_artifactId}/skeleton" includes="**/*" />
		</copy>
		<chmod file="resources/syntax_check.sh" perm="755"/>
		<chmod file="resources/phpunit.php" perm="755"/>
		<defaultexcludes add="**/.gitignore"/>
	</target>
	
	<target name="_create_packages">
		<mkdir dir="src/${project_groupId_as_path}/${project_artifactId}" />
		<mkdir dir="test/${project_groupId_as_path}/${project_artifactId}" />
		<copy file="lib/${arche_groupIdAsPath}/${arche_artifactId}/empty_gitignore" tofile="src/${project_groupId_as_path}/${project_artifactId}/.gitignore" />
		<copy file="lib/${arche_groupIdAsPath}/${arche_artifactId}/empty_gitignore" tofile="test/${project_groupId_as_path}/${project_artifactId}/.gitignore" />
	</target>

    <target name="_copy_pom">
        <copy file="lib/${arche_groupIdAsPath}/${arche_artifactId}/pom_example.xml" tofile="pom.xml" />
        <replace file="pom.xml" token="@add_project_artifacId_here@" value="${project_artifactId}"/>
        <replace file="pom.xml" token="@add_project_groupId_here@" value="${project_groupId}"/>
        <replace file="pom.xml" token="@add_project_version_here@" value="${project_version}"/>
    	<replace file="pom.xml" token="@add_download_url_here@" value="${mvn_download_repo}"/>
        <replace file="pom.xml" token="@add_upload_url_here@" value="${mvn_upload_repo}"/>
    	<replace file="pom.xml" token="@add_snapshot_download_url_here@" value="${mvn_snapshot_download_repo}"/>
    	<replace file="pom.xml" token="@add_snapshot_upload_url_here@" value="${mvn_snapshot_upload_repo}"/>
    </target>
	
	<target name="_copy_build-interface">
        <copy file="lib/de/bgeb/pandd/framework/build-interface.xml" tofile="build.xml" />
        <replace file="build.xml" token="@add_project_name_here@" value="${project_artifactId}"/>
        <replace file="build.xml" token="@add_build-impl_file_here@" value="lib/${arche_groupIdAsPath}/${arche_artifactId}/build-impl.xml"/>
	</target>

	<target name="_copy_pandd">
        <copy file="lib/${arche_groupIdAsPath}/${arche_artifactId}/pandd.php" tofile="pandd.php" />
        <replace file="pandd.php" token="@add_environment_here@" value="development"/>
	</target>
	
	
	<target name="_load_pom-file">
		<artifact:pom id="pomfile" file="pom.xml" />
	</target>
	
	<target name="clean_dist">
		<defaultexcludes remove="**/.gitignore"/>
		<delete includeEmptyDirs="true">
			<fileset dir="dist/compiled" includes="**/*" excludes=".gitignore" />
			<fileset dir="dist" includes="**/*" excludes="compiled/*" />
		</delete>
		<defaultexcludes add="**/.gitignore"/>
	</target> 
	
	<target name="clean_lib">
		<defaultexcludes remove="**/.gitignore"/>
        <delete includeEmptyDirs="true">
            <fileset dir="lib" includes="**/*" excludes=".gitignore" />
        </delete>       
		<defaultexcludes add="**/.gitignore"/>
	 </target> 
	
	<target name="clean" depends="clean_lib, clean_dist" />
	
	<target name="update-dependencies" depends="_load_pom-file, clean_lib">
		<artifact:dependencies filesetId="deps.fileset" useScope="test">
			<pom refid="pomfile"/>
   		</artifact:dependencies>
   		<unzip dest="lib">
    		<fileset refid="deps.fileset" />
   		</unzip>
	</target>

	<target name="post_update-dependencies">
	</target>
	
	<target name="_test_syntax">
		<exec executable="resources/syntax_check.sh" failonerror="true" />
	</target>

	<target name="_test_phpunit">
		<exec executable="php" failonerror="true">
			<arg line="resources/phpunit.php -c resources/phpunit.xml" />
		</exec>
	</target>	
	
	<target name="test" depends="_test_syntax, _test_phpunit" />

	<target name="publish" depends="_load_pom-file">
		<artifact:dependencies filesetId="deps.fileset" scopes="compile">
			<pom refid="pomfile"/>
   		</artifact:dependencies>
   		<unzip dest="dist/compiled/lib">
    		<fileset refid="deps.fileset" />
		    <patternset>
		        <exclude name="META-INF/"/>
		    	<exclude name="pom.xml build.xml"/>
		    </patternset>
  		</unzip>

        <copy file="lib/de/bgeb/pandd/arche/commonapp/pandd.php" tofile="dist/compiled/pandd.php" />
        <replace file="dist/compiled/pandd.php" token="@add_environment_here@" value="production"/>

		<zip destfile="dist/${pomfile.artifactId}-${pomfile.version}.zip">
			<zipfileset dir="./" includes="src/ public/ resources/ conf/ doc/" prefix="${pomfile.artifactId}-${pomfile.version}"/>
			<!-- Note: pandd-framework itself will be exluded -->
			<zipfileset dir="dist/compiled/" excludes="/de/bgeb/pandd/" prefix="${pomfile.artifactId}-${pomfile.version}" />
		</zip>
		
		<!-- delete compiled content to avoid double code suggestion in eclipse ide -->
		<defaultexcludes remove="**/.gitignore"/>
        <delete includeemptydirs="true" >
        	<fileset dir="dist/compiled" includes="**/*" excludes=".gitignore" />
        </delete>
		<defaultexcludes add="**/.gitignore"/>
	</target>

	<target name="mvn_package">
		<echo message="not implemented yet" />
	</target>
	<target name="mvn_install">
		<echo message="not implemented yet" />
	</target>
	<target name="mvn_deploy">
		<echo message="not implemented yet" />
	</target>
</project>